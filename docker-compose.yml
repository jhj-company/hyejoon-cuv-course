# ===============================
# ğŸš€ Docker Compose ì‹¤í–‰/ê´€ë¦¬ ëª…ë ¹ì–´
# -------------------------------
# ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
#   docker compose up -d
#
# ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€ + ë„¤íŠ¸ì›Œí¬ ì œê±° (ë°ì´í„° ìœ ì§€)
#   docker compose down
#
# ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€ + ë³¼ë¥¨/ë°ì´í„°ê¹Œì§€ ì‚­ì œ (ì£¼ì˜!)
#   docker compose down -v
#
# íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì¬ì‹œì‘ (ì˜ˆ: mysql)
#   docker compose restart mysql
#
# ë¡œê·¸ í™•ì¸ (ì˜ˆ: app container name: hjcuv-redis)
#   docker logs -f hjcuv-redis
#
# ë„ì»¤ ë‚´ë¶€ bash ì ‘ì†
#   docker exec -it <container_name> bash
#
# Redis ping í™•ì¸
#   docker exec -it hjcuv-redis redis-cli ping
# ===============================

version: "3.8"
services:
  mysql:
    image: mysql:8.0
    container_name: hjcuv-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: hjcuv
      MYSQL_USER: hjcuv
      MYSQL_PASSWORD: 1234
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql # MySQL ê³µì‹ ê¸°ë³¸ ë°ì´í„° ë””ë ‰í† ë¦¬

  mysql-dev:
    image: mysql:8.0
    container_name: hjcuv-mysql-dev
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: hjcuv-dev
      MYSQL_USER: hjcuv
      MYSQL_PASSWORD: 1234
    ports:
      - "3308:3306"
    volumes:
      - mysql_dev_data:/var/lib/mysql-dev # MySQL ê³µì‹ ê¸°ë³¸ ë°ì´í„° ë””ë ‰í† ë¦¬

  redis-lock:
    image: redis:7.4
    container_name: hjcuv-redis
    command: [ "redis-server", "--appendonly", "yes", "--appendfsync", "everysec", "--maxmemory-policy", "noeviction" ]
    ports:
      - "6379:6379"
    volumes:
      - redis_lock_data:/data # Redis ê³µì‹ ê¸°ë³¸ ë°ì´í„° ë””ë ‰í† ë¦¬

  mysqld_exporter:
    image: quay.io/prometheus/mysqld-exporter
    container_name: mysqld_exporter
    command:
      - "--mysqld.username=root:1234"
      - "--mysqld.address=hjcuv-mysql-dev:3306"
    ports:
      - "9104:9104"
    depends_on:
      - mysql-dev

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - mysqld_exporter

  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  mysql_data:
  redis_lock_data:
  mysql_dev_data:
  grafana_data:
